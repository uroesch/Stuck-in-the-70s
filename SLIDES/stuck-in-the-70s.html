<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>Stuck in the 70&#8217;s?: Sanitize shell script from the disco era</title><meta name="keywords" content="unix, shell, bash,"><meta name="author" content="Urs Roesch"><link rel="stylesheet" href="./css/reset.css"><link rel="stylesheet" href="./css/reveal.css"><link rel="stylesheet" href="./css/theme/70s.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* listing block */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}
</style><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/v4-shims.min.css"><!--Printing and PDF exports--><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "./css/print/pdf.css" : "./css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title"><h1>Stuck in the 70&#8217;s?</h1><h2>Sanitize shell script from the disco era</h2><p class="author"><small>Urs Roesch</small></p></section><section id="why-bash"><h2>Why bash?</h2><div class="slide-content"><div class="paragraph"><p>As part of my work I encounter many shell scripts which are poorly written
but are essential for the infrastructure to function properly.</p></div>
<div class="paragraph"><p>Most of the time the stake holders aren&#8217;t sufficiently trained to use a higher
level language such as <code>python</code>, <code>ruby</code> or <code>go</code>.</p></div>
<div class="paragraph"><p>By introducing modern <code>bash</code> features, the scripts can be maintained by
all stake holders without creating high hurdles for entry.</p></div>
<aside class="notes"><div class="paragraph"><p>Many times during my professional career I encountered the magical script
written by a former employee who left years ago. Said script was written in an
obscure language that was all the hype at the time but its star has faded since.
No one in the team has the time or is willing to learn the language, port it to
a more common language or they are simply too afraid of touching the code.</p></div>
<div class="paragraph"><p>I&#8217;m sure many have experienced similar situations. This presentation is an
introduction to modern <code>bash</code> script concepts to help sanitize old shell scripts
in need of a bit polish.</p></div></aside></div></section>
<section id="target-audience"><h2>Target audience</h2><div class="slide-content"><div class="paragraph"><p>If you often encounter shell or scripts written in <code>bash</code> and want
to learn a few tricks to make your and your co-worker&#8217;s life easier
this presentation is for you.</p></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">A basic understanding of programming in general and shell scripting
      in particular is assumed.</td></tr></table></div>
<div style="page-break-after: always;"></div></div></section>
<section><section id="error-checks"><h2>Errors, Shmerrors</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>Shell scripts are amazingly forgiving when it comes to bad coding practices.
Virtually every variable is globally available and can be used without being
previously declared.</p></div>
<div class="paragraph"><p>Further, fatal errors in other languages result in the termination of the
script, not so in a classic shell script. Even after a problem the script
jugs along as if everything is dandy.</p></div></aside></div></section><section id="_set_o_errexit"><h2>set -o errexit</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>The scripts I usually encounter do not exit on error. With this option set
the script is terminated when an error occurs.</p></div></aside>
<div class="listingblock"><div class="title">Script without <code>errexit</code> option</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

false
echo 'Still alive?' # Still alive?; exit rc 0</code></pre></div></div>
<div class="listingblock"><div class="title">Script with <code>errexit</code> option</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

set -o errexit

false               # exit rc 1
echo 'Still alive?'</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>To prevent exit on error, append <code>|| :</code> after the command.</p></div>
<div class="listingblock"><div class="title">Prevent exit on error</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

set -o errexit

false || :
echo 'Still alive?' # Still alive?; exit rc 0</code></pre></div></div></div></section><section id="_set_o_nounset"><h2>set -o nounset</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>Imagine a scenario where you remove a directory within a script where the last
part of the path is provided by a variable. For one reason or another said
variable is not defined and instead of the target directory you remove a lot
more than you bargained for.</p></div>
<div class="paragraph"><p><code>rm -rf /home/jdoe/${temp_dir}</code></p></div>
<div class="paragraph"><p>But don&#8217;t dispair with <code>set -o nounset</code> this can be prevented.</p></div></aside>
<div class="listingblock"><div class="title">Script without <code>nounset</code> option</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

rm -rf /home/jdoe/${temp_dir} # rm -rf /home/jdoe/</code></pre></div></div>
<div class="listingblock"><div class="title">Script with <code>nounset</code> option</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

set -o nounset

rm -rf /home/jdoe/${temp_dir} # bash: temp_dir: unbound variable; exit rc 1</code></pre></div></div></div></section><section id="_set_o_pipefail"><h2>set -o pipefail</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>When working with pipes per default only the right most command in the chain
is considered and checked for errors.</p></div>
<div class="paragraph"><p>With <code>pipefail</code> each command within the pipe construct is evaluted.
This is especially useful for <code>awk</code> commands which generally return and
exit status of <code>0</code>.</p></div></aside>
<div class="listingblock"><div class="title">Script without <code>pipefail</code> option</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

find /fake-dir | awk '{print $1}' # exit rc 0</code></pre></div></div>
<div class="listingblock"><div class="title">Script with <code>pipefail</code> option</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

set -o pipefail

find /fake-dir | awk '{print $1}' # exit rc 1</code></pre></div></div></div></section><section id="_summary"><h2>Summary</h2><div class="slide-content"><div class="paragraph"><p>Always use the option triplet <code>errexit</code>, <code>nounset</code> and <code>pipefail</code> in your
scripts!</p></div>
<aside class="notes"><div class="paragraph"><p>When refactoring an existing script add them first to see how far down the
rabbit whole the journey goes. If the script runs without a hitch the code might
not be as bad as assumed.</p></div></aside>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

[...]</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>To disable the option for a certain block or command use <code>+o</code> instead of <code>-o</code>.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">[...]

# switch off exit on error
set +o errexit
false
# switch it back on
set -o errexit

[...]</code></pre></div></div>
<aside class="notes"><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">The options for <code>errexit</code> and <code>nounset</code> can be written as <code>set -e</code> or
      <code>set -u</code> respectively. But I prefer writing them out to help a novice user
      to better understand these settings.</td></tr></table></div></aside>
<div style="page-break-after: always;"></div></div></section></section>
<section><section id="foobar"><h2>I do declare!</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>Variables in shell scripts are typeless, quite a few popular scripting
languages do the same and are loosely typed. With <code>declare</code> certain
attributes can be defined to make a script more predictable and
sometimes cut down on conversion logic.</p></div></aside></div></section><section id="_integer"><h2>Integer</h2><div class="slide-content"><div class="paragraph"><p>Ensure the variable only holds integers.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -i int=1

int=string    # bash: string: unbound variable

int=2         # declare -i int="2"</code></pre></div></div></div></section><section><div class="slide-content"><h3>Integer math</h3><div class="paragraph"><p>Fun fact, declaring a variable as an integer allows for simple integer math.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -i int

int=1+2      # declare -i int="3"    # addition
int=2-1      # declare -i int="1"    # subtraction
int=8/2      # declare -i int="4"    # division
int=9/2      # declare -i int="4"    # division rounded
int=9%2      # declare -i int="1"    # modulo
int=3*2      # declare -i int="6"    # multiplication</code></pre></div></div></div></section><section><div class="slide-content"><h3>Zero padded numbers</h3><div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Caution! The zero padded numbers <code>08</code> and <code>09</code> are interpreted as octal
and throw an error.</td></tr></table></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -i int

int=01  # declare -i int="1"
# ...
int=07  # declare -i int="7"
int=08  # bash: 08: value too great for base (error token is "08")
int=09  # bash: 09: value too great for base (error token is "09")</code></pre></div></div></div></section><section id="_readonly"><h2>Readonly</h2><div class="slide-content"><div class="paragraph"><p>Define a variable as a constant.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -r readonly=set-in-stone

readonly=change   # bash: readonly: readonly variable</code></pre></div></div></div></section><section id="_lowercase"><h2>Lowercase</h2><div class="slide-content"><div class="paragraph"><p>The content of the variable is converted to lowercase.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -l lower=LOWER

echo ${lower}    # lower</code></pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Requires bash &gt;= 4.0</td></tr></table></div></div></section><section id="_uppercase"><h2>Uppercase</h2><div class="slide-content"><div class="paragraph"><p>The content of the variable is converted to uppercase.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -u upper=upper

echo ${upper}    # UPPER</code></pre></div></div></div></section><section id="_arrays"><h2>Arrays</h2><div class="slide-content"><div class="paragraph"><p>The content of the variable is an array.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -a array=( 1 2 3 )

typeset -p array  # declare -a array=([0]="1" [1]="2" [2]="3" )

array=foo

typeset -p array  # declare -a array=([0]="foo" [1]="2" [2]="3")</code></pre></div></div></div></section><section id="_associative_arrays"><h2>Associative Arrays</h2><div class="slide-content"><div class="paragraph"><p>The content of the variable is an associative array.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -A hash=( [a]=foo [b]=bar )

typeset -p hash # declare -A hash=([b]="bar" [a]="foo" )

hash=c

typeset -p hash # declare -A hash=([0]="c" [b]="bar" [a]="foo" )

hash+=([c]=foo)

typeset -p hash # declare -A hash=([c]="foo" [b]="bar" [a]="foo" )</code></pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Requires bash &gt;= 4.0</td></tr></table></div></div></section><section id="_summary_2"><h2>Summary</h2><div class="slide-content"><div class="paragraph"><p>There are few other switches to <code>declare</code> and the certainly can be combined.
To create a readonly array use <code>declare -ra</code> for instance.</p></div>
<div class="paragraph"><p>Using <code>declare</code> helps narrowing the scope of the values a variable can hold.
This makes the script more predictable!</p></div>
<div style="page-break-after: always;"></div></div></section></section>
<section><section id="assignments"><h2>Operation plus equal</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>With Bash 3.1 the new assignment operator <code>+=</code> was introduced.
It makes the previously cumbersome task of appending or adding content to
an already populated variable a lot easier and DRYer.
The following examples show the classical way and the new improved way.</p></div></aside></div></section><section id="_integer_incrementation"><h2>Integer incrementation</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>There is a few ways incrementing integers in bash but the focus is on the <code>+=</code>
assignment operator.</p></div></aside>
<div class="listingblock"><div class="title">Classical way</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">counter=0
while true; do
  counter=`expr ${counter} + 1`   # declare -- counter="1"
  # [...]
done</code></pre></div></div>
<div class="listingblock"><div class="title">With <code>+=</code> operator</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -i counter=0
while true; do
  counter+=1                      # declare -i counter="1"
  # [...]
done</code></pre></div></div></div></section><section><div class="slide-content"><div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Without declaring the variable as an integer the behavior
         is not as expected.</td></tr></table></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">counter=0
while true; do
  counter+=1                      # declare -- counter="01"
  # [...]
done</code></pre></div></div></div></section><section id="_append_to_string"><h2>Append to string</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>The <code>+=</code> assignment operator acts differently when a string is
encountered.</p></div></aside>
<div class="listingblock"><div class="title">Classical way</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">string="foo"
string="${string}bar"  # declare -- string="foobar"</code></pre></div></div>
<div class="listingblock"><div class="title">With <code>+=</code> operator</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -- string=foo
string+=bar            # declare -- string="foobar"</code></pre></div></div></div></section><section id="_push_to_array"><h2>Push to array</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>Using the <code>+=</code> assignment operator with a list or array
pushes a new value into an array.</p></div></aside>
<div class="listingblock"><div class="title">Classical list</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">list="foo"
list="${list} bar" # declare -- list="foo bar"</code></pre></div></div>
<div class="listingblock"><div class="title">With <code>+=</code> operator</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -a list=( foo )
list+=( bar )      # declare -a list=(foo bar)</code></pre></div></div></div></section><section id="_summary_3"><h2>Summary</h2><div class="slide-content"><div class="paragraph"><p>The <code>+=</code> operator helps with the assignment of existing and brings
a bit more comfort to the previously wordy and often times ugly process
of appending or incrementing numbers.</p></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">A <code>-=</code> assignment operator does not exist!</td></tr></table></div>
<div style="page-break-after: always;"></div></div></section></section>
<section><section id="parameter-expansion"><h2>Substitution Revolution</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>Some may know the classical parameter expansion from Bourne shell such as
<code>${parameter:N,N}</code> or <code>${parameter:-default}</code> or the ones from Korn shell
<code>${parameter%pattern}</code> or <code>${parameter#pattern}</code>. But bash has a few of
its own. We look at three of them.</p></div></aside></div></section><section id="_modify_case"><h2>Modify case</h2><div class="slide-content"><div class="paragraph"><p>There are two basic modes, the first is to convert the case
of the first letter. The second is to convert the whole string.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -- to_lower="ALL CAPS"
echo ${to_lower,}               # aLL CAPS
echo ${to_lower,,}              # all caps

declare -- to_upper="all lower"
echo ${to_upper^}               # All lower
echo ${to_upper^^}              # ALL LOWER</code></pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Requires bash &gt;= 4.0</td></tr></table></div></div></section><section><div class="slide-content"><div class="paragraph"><p>There is also the option of only matching a pattern to
adjust the case.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -- fruits="banana apple pear"
echo ${fruits^a}                # banana apple pear
echo ${fruits^[bp]}             # Banana apple pear
echo ${fruits^^a}               # bAnAnA Apple peAr
echo ${fruits^^[ae]}            # bAnAnA ApplE pEAr</code></pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Requires bash &gt;= 4.0</td></tr></table></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="title">Real world example</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">if [ `echo ${string1} | tr "[A-Z]" "[a-z]"` = "${string2}" ]; then
  # [...]
fi</code></pre></div></div>
<div class="listingblock"><div class="title">With parameter expansion</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">if [[ ${string1,,} == ${string2} ]]; then
  # [...]
fi</code></pre></div></div></div></section><section id="_substitution"><h2>Substitution</h2><div class="slide-content"><div class="paragraph"><p>This one really gets me! I almost never see <code>${parameter/pattern/}</code>
substitutions in the wild. And is has been around for ages.</p></div>
<aside class="notes"><div class="paragraph"><p>Given it is not as powerful as <code>sed</code> but for most use cases it is more than
sufficient.</p></div></aside>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -- string="lagoon racoon"
echo ${string/oo/u}             # lagun racoon
echo ${string//oo/u}            # lagun racun</code></pre></div></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="title">Real world example</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">string="lagoon racoon"
echo ${string} | sed 's/oo/u/g' # lagun racun</code></pre></div></div>
<div class="listingblock"><div class="title">With parameter expansion</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -- string="lagoon racoon"
echo ${string//oo/u}             # lagun racun</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>The script below loops 1000 times and does a string substitution with <code>sed</code> and
then via the <code>bash</code> builtin substitution. The result is quite stunning. The
builtin is is factors faster.</p></div>
<div class="listingblock"><div class="title">Example script <code>letter-substitution.sh</code></div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

declare -r TITLE="\nSubstitute 'o' for 'u' in string with '%s' a 1000 times\n"
declare -r STRING="lagoon racoon spoon loon"

function sed-loop() {
  printf "${TITLE}" 'sed'
  for i in {0..1000}; do
    sed 's/o/u/g' &lt;&lt;&lt; ${STRING} &amp;&gt;/dev/null
  done
}

function builtin-loop() {
  printf "${TITLE}" '${var//o/u}'
  for i in {0..1000}; do
    echo ${STRING//o/u} &amp;&gt;/dev/null
  done
}

time sed-loop
time builtin-loop</code></pre></div></div>
<div class="listingblock"><div class="title">Results</div><div class="content"><pre class="highlight"><code class="language-console" data-lang="console">$ bash letter-substitution.sh

Substitute 'o' for 'u' in string with 'sed' a 1000 times

real    0m1.613s <i class="conum" data-value="1"></i><b>(1)</b>
user    0m1.008s
sys     0m0.669s

Substitute 'o' for 'u' in string with '${var//o/u}' a 1000 times

real    0m0.020s <i class="conum" data-value="2"></i><b>(2)</b>
user    0m0.020s
sys     0m0.000s</code></pre></div></div>
<div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td><code>sed</code> takes about 8 times longer to complete the job</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>Builtin is blazingly fast as it does not spawns a subshell for
every substitution.</td></tr></table></div></aside></div></section><section id="_summary_4"><h2>Summary</h2><div class="slide-content"><div class="paragraph"><p>Parameter expansion in shell scripts can be a bit cryptic at first but it
is definitely a lot faster then to run a sub shell for every little change
made to a small string.</p></div>
<div class="paragraph"><p>There are many more expansions available but the examples here are bash specific
and won&#8217;t work in the predecessor shells such as Bourne or Korn shell.</p></div>
<div style="page-break-after: always;"></div></div></section></section>
<section><section id="arrays"><h2>( hip hip )</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>Arrays have been around in bash for quite some time but the encounters
in the real world are few and far between.</p></div>
<div class="paragraph"><p>Combined with the parameter expansion they become a powerful asset
DRYing up a WET script.</p></div>
<div class="paragraph"><p>Here a few examples.</p></div></aside></div></section><section id="_modify_case_2"><h2>Modify case</h2><div class="slide-content"><div class="paragraph"><p>Combining bash arrays with the upper case parameter expansion is mighty
powerful. Let&#8217;s see how it&#8217;s done.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -a fruit=( banana apple pear )
echo ${fruit[@]^}               # Banana Apple Pear
echo ${fruit[@]^^}              # BANANA APPLE PEAR
echo ${fruit[@]^a}              # banana Apple pear
echo ${fruit[@]^[bp]}           # Banana apple Pear
echo ${fruit[@]^^a}             # bAnAnA Apple peAr
echo ${fruit[@]^^[ae]}          # bAnAnA ApplE pEAr</code></pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Requires bash &gt;= 4.0</td></tr></table></div></div></section><section id="_substitution_2"><h2>Substitution</h2><div class="slide-content"><div class="paragraph"><p>Applying substitution to each element of an array can also be done.
Here a few examples.</p></div>
<div class="listingblock"><div class="title">General substitutions</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -a array=( lagoon racoon )
echo ${array[@]/o/u}          # laguon racuon
echo ${array[@]//o/u}         # laguun racuun</code></pre></div></div>
<div class="listingblock"><div class="title">Prefix substitutions</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -a sshopts=( BatchMode=yes User=foobar )
echo ${sshopts[@]/#/-o }      # -o BatchMode=yes -o User=foobar</code></pre></div></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="title">Append suffix</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -a fruits=( banana apple pear )
echo ${fruits[@]/%/,}         # banana, apple, pear,</code></pre></div></div>
<div class="listingblock"><div class="title">Remove suffix</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -a fruits=( bananas apples pears )
echo ${fruits[@]/%s/}         # banana apple pear</code></pre></div></div></div></section><section id="_summary_5"><h2>Summary</h2><div class="slide-content"><div class="paragraph"><p>Parameter expansion combined with bash arrays allows to make volatile changes
to a list of values at the time of echoing. No <code>sed</code>, <code>tr</code> and <code>awk</code> constructs
and excessive looping are required.</p></div>
<div style="page-break-after: always;"></div></div></section></section>
<section><section id="conditionals"><h2>Perfect condition</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>Conditional statements in classical shell script have a few
shortcomings. For backward compatibility bash understands
the single brackets <code>[ &#8230;&#8203; ]</code> but are a couple more ways
to enclose conditional statements.</p></div>
<div class="paragraph"><p>Let&#8217;s dive in.</p></div></aside></div></section><section id="_double_square_brackets"><h2>Double square brackets</h2><div class="slide-content"><div class="paragraph"><p>Double square brackets are more forgiving when
it comes to dealing with empty strings in a comparison.</p></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="title">Classical shell script condition</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">foo=
[ ${foo} = foo ]      # bash: [: =: unary operator expected</code></pre></div></div>
<div class="paragraph"><p>Effectively the above conditional statement is expanded as
<code>[ = foo ]</code> because the variable <code>foo</code> is empty.
There are two common ways to prevent the error:</p></div>
<div class="listingblock"><div class="title">Classical shell script condition workaround</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">foo=
[ "${foo}" = "foo" ]  # exit rc 1
[ x${foo} = xfoo ]    # exit rc 1</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Korn shell introduced the more robusts <code>[[</code> which does not
suffer the same limitations.</p></div>
<div class="listingblock"><div class="title">Korn shell style double square brackets</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -- foo=
[[ ${foo} == foo ]]   # exit rc 1</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>Korn was initially released in 1983. <code>bash</code> and <code>zsh</code> among other
shells adapted the double square bracket style conditionals.
Still to this day there I mostly encounter single square brackets all
over the place. Hence the question "Are we stuck in the 70&#8217;s?".</p></div>
<div class="paragraph"><p>And while the double square brackets are not POSIx compliant, does
it really matter if you are writing a bash script?</p></div></aside></div></section><section id="_regex_comparison"><h2>Regex comparison</h2><div class="slide-content"><div class="paragraph"><p>Bash has also a regex operator <code>=~</code> for matching strings.
This often overlooked feature can save you lots of typing.</p></div>
<aside class="notes"><div class="paragraph"><p>More importantly string comparisons within bash are more
performant as no sub shell is required for the comparison.</p></div></aside>
<div class="listingblock"><div class="title">Classical shell string match</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">string=foobar
if echo ${string} | grep -q '[Bb]ar'; then
  # [ ... ]
fi</code></pre></div></div>
<div class="listingblock"><div class="title">Bash style regex</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -- string=foobar
if [[ ${string} =~ [Bb]ar ]]; then
  # [ ... ]
fi</code></pre></div></div></div></section><section id="_summary_6"><h2>Summary</h2><div class="slide-content"><div class="paragraph"><p>These are but a few small examples creating "perfect conditions"
for your bash scripts. Although they are not POSIX compatible
the fact that <code>ksh</code>, <code>zsh</code> and <code>bash</code> among other implement them
makes them virtually portable.</p></div>
<div style="page-break-after: always;"></div></div></section></section>
<section><section id="functions"><h2>Funky, funky, functions!</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>Function names are quite restrictive in many languages. For instance
minuses <code>-</code> are not permitted or special characters can not be used.</p></div>
<div class="paragraph"><p>While this is true for traditional shell scripts as well Bash has
more relaxed rules.</p></div>
<div class="paragraph"><p>Let&#8217;s dive in!</p></div></aside></div></section><section id="_special_characters"><h2>Special characters</h2><div class="slide-content"><div class="paragraph"><p>With the exception of a few reserved characters such as <code>$</code>, <code>|</code>,
<code>(</code> and <code>{</code> among others pretty much everything else works.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">function @() { echo '@'; }
@                                        # @
function /() { echo '/'; }
/                                        # /
function -() { echo '-'; }
-                                        # -
function :() { echo ':'; }
:                                        # :
function ü() { echo 'ü'; }
ü                                        # ü
function 照() { echo '照'; }
照                                       # 照</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>This opens possibilities of creating prefixes or fake namespaces
for functions. Pretty useful for sourced files and libraries.</p></div>
<div class="listingblock"><div class="title">Functions with faux namespaces</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">function funky() {
  # [ ... ]
}

function test::funky() {
  # [ ... ]
}

funky            # execute funky
test::funky      # test funky function</code></pre></div></div></div></section><section id="_function_within_functions"><h2>Function within functions</h2><div class="slide-content"><div class="paragraph"><p>It it is even possible to place functions within functions.
Unfortunately there they are still accessible globally.</p></div>
<aside class="notes"><div class="paragraph"><p>There is a use case for this scenario which we get to later.
But with the <code>local</code> keyword the scope can be limited.</p></div></aside>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">function parent() {
  function @child() {
    # [ ... ]
  }
  @child
  # [ ... ]
  @child
}</code></pre></div></div></div></section><section id="_summary_7"><h2>Summary</h2><div class="slide-content"><div class="paragraph"><p>Surprisingly bash functions can be creatively named and have fewer restrictions
than most other scripting languages. Caution is advised when using special
characters tho. I don&#8217;t think many bash scripters use them.</p></div>
<div style="page-break-after: always;"></div></div></section></section>
<section><section id="printf"><h2>What the printf?</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>The builtin <code>printf</code> function comes with a few differences compared
to the ones found in the common scripting languages.</p></div>
<div class="paragraph"><p>Here we have a look how we can use <code>printf</code> a log smarter!</p></div></aside></div></section><section id="_dont_loop_printf"><h2>Don&#8217;t loop, printf!</h2><div class="slide-content"><div class="paragraph"><p>The bash <code>printf</code> can be used instead of a loop for printing as it
prints each additional argument not unlike a loop.</p></div>
<div class="listingblock"><div class="title">Print fruit loop :)</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -a fruit=( banana apple pear )
for f in ${fruit[@]}; do echo ${f}; done    # banana\napple\npear</code></pre></div></div>
<div class="listingblock"><div class="title">Printf it!</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -a fruit=( banana apple pear )
printf "%s\n" "${fruit[@]}"                 # banana\napple\npear</code></pre></div></div></div></section><section id="_straight_lines"><h2>Straight lines</h2><div class="slide-content"><div class="paragraph"><p>Don&#8217;t manually write out lines use <code>printf</code>!</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">printf "%0.1s" -{1..16}         # ----------------</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>Packing the above into a function and calling it <code>-----</code> can make
the source code more readable but probably confuses the casual
code reviewer.</p></div>
<div class="listingblock"><div class="title">Example script <code>pretty-lines.sh</code></div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

function -----() {
  printf "%0.1s" -{1..16} $'\n'
}

-----
echo "Title"
-----</code></pre></div></div>
<div class="listingblock"><div class="title">Result</div><div class="content"><pre class="highlight"><code class="language-console" data-lang="console">$ bash pretty-lines.sh
----------------
Title
----------------</code></pre></div></div></aside></div></section><section id="_sprintf_anyone"><h2>sprintf anyone?</h2><div class="slide-content"><div class="paragraph"><p>One can even emulate the <code>sprintf</code> function by using the <code>-v</code>
switch.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">printf -v line "%0.1s" -{1..16}
echo ${line}                    # ----------------</code></pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Requires bash &gt;= 3.1</td></tr></table></div></div></section><section id="_escape_plan"><h2>Escape plan!</h2><div class="slide-content"><div class="paragraph"><p>With the <code>%q</code> placeholder <code>printf</code> provides a shell escaping routine.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">printf "%q" 'cat foo | grep "foo bar"'
# cat\ foo\ \|\ grep\ \"foo\ bar\"</code></pre></div></div></div></section><section id="_what_does_the_clock_say"><h2>What does the clock say?</h2><div class="slide-content"><div class="paragraph"><p>Use <code>printf</code> instead of the <code>date</code> command to convert
an Unix epoch timestamp to a human readable format.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">printf "%(%Y-%m-%d)T\n" 1515151515
2018-01-05</code></pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Requires bash &gt;= 4.2</td></tr></table></div></div></section><section id="_summary_8"><h2>Summary</h2><div class="slide-content"><div class="paragraph"><p>IMHO, one of most underused builtin in bash scripts is printf.
It is very versatile and can help reduce code and complexity if used
appropriately.</p></div>
<div style="page-break-after: always;"></div></div></section></section>
<section><section id="real-world"><h2>Real World Examples ™</h2><div class="slide-content"><div class="paragraph"><p>A few examples on how to reduce clutter with examples
taken from the Real World ™.</p></div></div></section><section id="_the_power_of_reading"><h2>The power of read(ing)</h2><div class="slide-content"><div class="listingblock"><div class="title">Expensive parsing and splitting with awk</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">info="Joe:Doe:Sysadmin"
fname=`echo ${info} | awk -F : '{ print $1 }'`   # Joe
lname=`echo ${info} | awk -F : '{ print $2 }'`   # Doe
role=`echo ${info} | awk -F : '{ print $3 }'`    # Sysadmin</code></pre></div></div>
<div class="listingblock"><div class="title">read with IFS</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -- info="Joe:Doe:Sysadmin"
IFS=: read fname lname role &lt;&lt;&lt; "${info}"</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>The same but read everything into an array.</p></div>
<div class="listingblock"><div class="title">read into array</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">declare -- info="Joe:Doe:Sysadmin"
IFS=: read -a person &lt;&lt;&lt; "${info}"

typeset -p person   # declare -a person=([0]="Joe" [1]="Doe" [2]="Sysadmin")</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>Splitting field separated data into variables is usually down with <code>awk</code> in
shell scripts. And <code>awk</code> is superb tools when working on large data sets.
However simply splitting into shell variables is a performance killer!</p></div>
<div class="listingblock"><div class="title">Example script <code>read-list.sh</code></div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

declare -r TITLE="\nSplit string to variables with '%s' a 100 times\n"
declare -r LIST="root:T0pS3cr3t!:0:0:root:/root:/bin/bash"

function awk-loop() {
  printf "${TITLE}" 'awk -F : ...'
  for i in {0..100}; do
    login=$(echo ${LIST} | awk -F : '{ print $1 }')
    pw=$(echo ${LIST} | awk -F : '{ print $2 }')
    uid=$(echo ${LIST} | awk -F : '{ print $3 }')
    gid=$(echo ${LIST} | awk -F : '{ print $4 }')
    gecos=$(echo ${LIST} | awk -F : '{ print $5 }')
    home=$(echo ${LIST} | awk -F : '{ print $6 }')
    shell=$(echo ${LIST} | awk -F : '{ print $7 }')
  done
}

function read-loop() {
  printf "${TITLE}" 'IFS=: read ...'
  for i in {0..100}; do
    IFS=: read login pw uid gid gecos home shell &lt;&lt;&lt; "${LIST}"
  done
}

time awk-loop
time read-loop</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-console" data-lang="console">$ bash read-list.sh

Split string to variables with 'awk -F : ...' a 100 times

real    0m1.162s <i class="conum" data-value="1"></i><b>(1)</b>
user    0m1.086s
sys     0m0.293s

Split string to variables with 'IFS=: read ...' a 100 times

real    0m0.002s <i class="conum" data-value="2"></i><b>(2)</b>
user    0m0.001s
sys     0m0.002s</code></pre></div></div>
<div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>Splitting with <code>awk</code> is about 580 times slower!
Although there are only 100 iterations <code>awk</code> is
called 700 times.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>Barely noticeable the time used with the builtin.</td></tr></table></div></aside></div></section><section id="_may_the_case_be_with_you"><h2>May the case be with you</h2><div class="slide-content"><div class="listingblock"><div class="title">Too WET to maintain</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">if [ ${host} = jp-prod ]; then
  prod_host ${host}
elif [ ${host} = ch-prod ]; then
  prod_host ${host}
elif [ ${host} = jp-uat ]; then
  uat_host ${host}
# [ ... ]
else
  dev_host ${host}
fi</code></pre></div></div>
<div class="listingblock"><div class="title">Better with case</div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">case ${host} in
  *-prod) prod_host ${host};;
  *-uat)  uat_host ${host};;
  *)      dev_host ${host};;
esac</code></pre></div></div></div></section><section id="_poor_mans_ansible"><h2>Poor man&#8217;s Ansible</h2><div class="slide-content"><div class="paragraph"><p>Execute a locally defined function on a remote machine without
first copying the code.</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">function bootstrap() { config_host; hostname; }

ssh ch-dev.acme.com "$(declare -f bootstrap); bootstrap"</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>It is hard to imagine something concrete with the above example hence a small
example to show how it works. In the below example the script is adding a new
SSH public key to the target user&#8217;s authorized_keys file. But only if the key
is not already existing.</p></div>
<div class="listingblock"><div class="title">Example script <code>rex-add_ssh_key.sh</code></div><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

function add_ssh_key() {
  set -o errexit
  set -o nounset
  set -o pipefail

  declare -r SSH_TYPE=${1}; shift;
  declare -r SSH_KEY=${1}; shift;
  declare -r SSH_COMMENT=${1}; shift;
  declare -r AUTH_KEYS=${HOME}/.ssh/authorized_keys

  function key_already_in_place() {
    grep -q ${SSH_KEY} ${AUTH_KEYS}
  }

  function add_key() {
    key_already_in_place &amp;&amp; {
      echo "Key already exists in ${AUTH_KEYS}";
      return 0;
    }
    printf "%s %s %s\n" \
      ${SSH_TYPE} \
      ${SSH_KEY} \
      ${SSH_COMMENT} \
      &gt;&gt; ${AUTH_KEYS}
    echo "Key successfully added to ${AUTH_KEYS}"
  }
  add_key
}

ssh localhost \
  "$(declare -f add_ssh_key);" \
  "add_ssh_key ssh-ed25519 AAAAC3N..7mG testkey"</code></pre></div></div>
<div class="listingblock"><div class="title">Results from running above script</div><div class="content"><pre class="highlight"><code class="language-console" data-lang="console">$ bash rex-add_ssh_key.sh
Key succesfully added to /home/test/.ssh/authorized_keys <i class="conum" data-value="1"></i><b>(1)</b>

$ bash rex-add_ssh_key.sh
Key already exists in /home/test/.ssh/authorized_keys <i class="conum" data-value="2"></i><b>(2)</b></code></pre></div></div>
<div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>Running the first time the key is added</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>Running the second time the key is already present and no
action is taken.</td></tr></table></div></aside>
<div style="page-break-after: always;"></div>
<div style="page-break-after: always;"></div></div></section></section>
<section id="eof"><h2>EOF</h2><div class="slide-content"><div class="paragraph"><p><span class="icon"><i class="fa fa-github"></i></span> <strong><a href="https://github.com/uroesch/Stuck-in-the-70s" class="bare">https://github.com/uroesch/Stuck-in-the-70s</a></strong></p></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content"><div class="paragraph"><p>No Sysadmin was hurt during the making of this presentation!</p></div></td></tr></table></div></div></section></div></div><script src="./js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: true,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: false,
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: false,
  // Push each slide change to the browser history. Implies `hash: true`
  history: false,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 0,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'slide',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 960,
  height: 700,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: './plugin/zoom-js/zoom.js', async: true },
      { src: './plugin/notes/notes.js', async: true }
  ],

  

});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(960, 700)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(960, 700)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(960, 700)
});</script></body></html>